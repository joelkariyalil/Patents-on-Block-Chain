<!DOCTYPE html>
<html>
<head>
  <title>MetaMask Patent Submit</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
</head>
<body style="font-family: sans-serif;">
  <h3>üìâ Record Your Patent to Blockchain</h3>

  <p><strong>CID:</strong> <span id="cid"></span></p>
  <p><strong>Score:</strong> <span id="score"></span></p>
  <p><strong>Decision:</strong> <span id="decision"></span></p>

  <button onclick="connectWallet()">Connect Wallet</button>
  <button onclick="submitPatent()">Submit to Blockchain</button>

  <pre id="log" style="background: #f4f4f4; padding: 10px; margin-top: 10px;"></pre>

  <script>
    // Replace with your deployed contract values
    const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
    const ABI = [
      {
        "inputs": [
          {"internalType": "string", "name": "cid", "type": "string"},
          {"internalType": "uint256", "name": "score", "type": "uint256"},
          {"internalType": "string", "name": "decision", "type": "string"}
        ],
        "name": "storeResult",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    // Replace these with actual values injected from Streamlit
    const url = new URL(window.location.href);
    const CID = url.searchParams.get("cid");
    const SCORE = parseInt(url.searchParams.get("score"));
    const DECISION = url.searchParams.get("decision");

    document.getElementById("cid").innerText = CID;
    document.getElementById("score").innerText = SCORE;
    document.getElementById("decision").innerText = DECISION;

    let signer;

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        document.getElementById("log").innerText = "üöÄ Wallet connected: " + await signer.getAddress();
      } else {
        document.getElementById("log").innerText = "‚ùå MetaMask not detected.";
      }
    }

    async function submitPatent() {
      try {
        const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        const tx = await contract.storeResult(CID, SCORE, DECISION);
        document.getElementById("log").innerText = "‚è≥ Waiting for transaction: " + tx.hash;
        await tx.wait();
        document.getElementById("log").innerText = "‚úÖ Success! TX Hash: " + tx.hash;
      } catch (e) {
        document.getElementById("log").innerText = "‚ùå Error: " + e.message;
      }
    }
  </script>
</body>
</html>
